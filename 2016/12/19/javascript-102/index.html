<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>JavaScript 102 · Afterhip Tech Blog</title><meta name="description" content="JavaScript 102 - Aftership Engineer"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://techblog.aftership.com/atom.xml" title="Afterhip Tech Blog"></head><body><div class="wrap"><header><a class="logo-link" href="/"><img src="/logo.svg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link" href="/" target="_self">BLOG</a></li><li class="nav-list-item"><a class="nav-list-link" href="/archives/" target="_self">ARCHIVE</a></li><li class="nav-list-item"><a class="nav-list-link" href="https://github.com/aftership" target="_blank">GITHUB</a></li><li class="nav-list-item"><a class="nav-list-link" href="/atom.xml" target="_self">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">JavaScript 102</h1><div class="post-info"><p>by Hans Lee</p>Dec 19, 2016</div><div class="post-content"><p>JavaScript is essential to companies using <code>Node.js</code>. It’s THE language of year 2016. However, it is also a fragile language could be easily abused.</p>
<a id="more"></a>
<h2 id="Road-toward-clean-code-less-bug"><a href="#Road-toward-clean-code-less-bug" class="headerlink" title="Road toward clean code (less bug)"></a>Road toward clean code (less bug)</h2><p>In this article, I am going to demonstrate some best practices in JavaScript with examples.</p>
<h2 id="sum-function"><a href="#sum-function" class="headerlink" title="sum function"></a><code>sum</code> function</h2><p>To begin with, we are required to write a simple sum function. Here is the requirement:</p>
<ol>
<li>the function accepts <strong>1</strong> argument - an array of numbers</li>
<li>the function should return the sum of all the numbers inside the array</li>
</ol>
<h3 id="for-loop-not-recommended"><a href="#for-loop-not-recommended" class="headerlink" title="for loop (not recommended)"></a>for loop (not recommended)</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// array = [1,2,3,4]</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum</span>(<span class="params">array</span>) </span>&#123;</div><div class="line">  <span class="keyword">let</span> result = <span class="number">0</span>;</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; array.length; i++) &#123;</div><div class="line">    result += array[i];</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The first approach is intuitive: use traditional <code>for</code> loop. There is nothing wrong about it, but as a js developer, we could do better.</p>
<h3 id="for-…-in-loop-DEPRECATED-DO-NOT-USE"><a href="#for-…-in-loop-DEPRECATED-DO-NOT-USE" class="headerlink" title="for … in loop (DEPRECATED, DO NOT USE)"></a>for … in loop (<strong>DEPRECATED</strong>, DO NOT USE)</h3><p>And here is the famous <code>foo ... in</code> loop.</p>
<p>As you can see, the obvious drawback of <code>for ... in</code> loop is that it could iterate over all of the keys and all the keys on it’s prototype chain inside an object (array is also an object in js), therefore we have this <code>hasOwnProperty</code> check.</p>
<p>an astonishing fact is that a lot of programmers from other languages really love this approach… However, the cold fact is due to the cumbersome <code>hasOwnProperty</code> check, <code>for ... in</code> loop is seldom used in most of the <code>Node.js</code> project, and even considered bad practice when iterate over a collection.</p>
<p>Here is the reason:</p>
<blockquote>
<p> The for-in statement by itself is not a “bad practice”, however it can be mis-used, for example, to iterate over arrays or array-like objects.</p>
<p>The purpose of the for-in statement is to enumerate over object properties. This statement will go up in the prototype chain, also enumerating over inherited properties, a thing that sometimes is not desired.</p>
<p>Also, the order of iteration is not guaranteed by the spec., meaning that if you want to “iterate” an array object, with this statement you cannot be sure that the properties (array indexes) will be visited in the numeric order.</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// array = [1,2,3,4]</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum</span>(<span class="params">array</span>) </span>&#123;</div><div class="line">  <span class="keyword">let</span> result = <span class="number">0</span>;</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> index <span class="keyword">in</span> array) &#123;</div><div class="line">    <span class="keyword">if</span> (array.hasOwnProperty(index)) &#123;</div><div class="line">      result += array[index];</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>If one should iterate over every property in an <code>object</code> (<code>{}</code>) rather than <code>array</code> (<code>[]</code>), consider use those methods:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">Object</span>.keys           &lt;-&gt; _.keys</div><div class="line"><span class="built_in">Object</span>.values  (es7)  &lt;-&gt; _.values</div><div class="line"><span class="built_in">Object</span>.entries (es7)  &lt;-&gt; _.pairs</div></pre></td></tr></table></figure>
<p>Those methods are not following the prototype chain to do an exhaustive search so they may even have better performance compared to the <code>for ... in</code> loop.</p>
<h3 id="for-…-of-loop-es6-Okay-not-the-best"><a href="#for-…-of-loop-es6-Okay-not-the-best" class="headerlink" title="for … of loop (es6) (Okay.. not the best)"></a>for … of loop (es6) (Okay.. not the best)</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// array = [1,2,3,4]</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum</span>(<span class="params">array</span>) </span>&#123;</div><div class="line">  <span class="keyword">let</span> result = <span class="number">0</span>;</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> number <span class="keyword">of</span> array) &#123;</div><div class="line">    result += number;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>this is a more recommended way to iterate a collection (or iterable to be precise).</p>
<p><code>for ... of</code> will not follow the prototype chain as well, because it can only be used on <code>iterable object</code>. And <code>Array</code> in es6 is implemented as an iterable. <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Iterators_and_Generators" target="_blank" rel="external">iterable-mdn</a></p>
<h3 id="Array-prototype-forEach-Okay-not-the-best"><a href="#Array-prototype-forEach-Okay-not-the-best" class="headerlink" title="Array.prototype.forEach (Okay, not the best)"></a>Array.prototype.forEach (Okay, not the best)</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// array = [1,2,3,4]</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum</span>(<span class="params">array</span>) </span>&#123;</div><div class="line">  <span class="keyword">let</span> result = <span class="number">0</span>;</div><div class="line">  array.forEach(<span class="function"><span class="params">number</span> =&gt;</span> result += number);</div><div class="line">  <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Nothing wrong about it, but we still need a <code>result</code> tmp var.</p>
<h3 id="Array-prototype-reduce-better"><a href="#Array-prototype-reduce-better" class="headerlink" title="Array.prototype.reduce (better)"></a>Array.prototype.reduce (better)</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// array = [1,2,3,4]</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum</span>(<span class="params">array</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> array.reduce(<span class="function">(<span class="params">pre, cur</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">return</span> pre + cur;</div><div class="line">  &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>this it the killer function of javascript, reduce function simply turns a <code>collection</code> in to a single value.</p>
<div class="tip"><br>Remember, you MUST return the accumulated result in the reducer function<br></div>

<p>We finally get rid of the annoying tmp var <code>result</code>! Yeal~</p>
<h3 id="sum-best"><a href="#sum-best" class="headerlink" title="_.sum (best)"></a>_.sum (best)</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// array = [1,2,3,4]</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum</span>(<span class="params">array</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> _.sum(array);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The real killer in JavaScript is the <code>lodash</code> library. It has became the de-factor JavaScript utility library. So Whenever you starts to write a function, the first thing to come up is always:</p>
<p>can i achieve it in lodash?</p>
<p>can i achieve it in lodash?</p>
<p>can i achieve it in lodash?</p>
<p>(have to repeat 3 times to emphersize important things)</p>
<div class="tip"><br>Always exploring lodash for data transformation tasks<br></div>

<h2 id="clean-function"><a href="#clean-function" class="headerlink" title="clean function"></a><code>clean</code> function</h2><p>consider the <code>clean</code> function here:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ['tag1', 'tag2', 'tag1  '] -&gt; ['tag1', 'tag2']</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">clean</span>(<span class="params">tags</span>) </span>&#123;</div><div class="line">  <span class="keyword">let</span> dedupe = &#123;&#125;;</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; tags.length; i++)&#123;</div><div class="line">    tags[i] = tags[i].trim();</div><div class="line">    <span class="keyword">const</span> aTag = tags[i];</div><div class="line"></div><div class="line">    <span class="keyword">if</span>(dedupe[aTag]) &#123;</div><div class="line">      tags.splice(i, <span class="number">1</span>);</div><div class="line">      i--;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      dedupe[aTag] = <span class="literal">true</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> tags;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>it takes some time to brain-parse this function, it seems to work but it has a potential bug: it changes the reference of the argument passed in.</p>
<h3 id="impurity"><a href="#impurity" class="headerlink" title="impurity"></a>impurity</h3><figure class="highlight diff"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">// ['tag1', 'tag2', 'tag1  '] -&gt; ['tag1', 'tag2']</div><div class="line">function clean(tags) &#123;</div><div class="line">  let dedupe = &#123;&#125;;</div><div class="line">  for (let i = 0; i &lt; tags.length; i++)&#123;</div><div class="line"><span class="deletion">-    tags[i] = tags[i].trim(); // mutates the tags</span></div><div class="line">    const aTag = tags[i];</div><div class="line"></div><div class="line">    if(dedupe[aTag]) &#123;</div><div class="line"><span class="deletion">-      tags.splice(i, 1); // mutates the tags</span></div><div class="line">      i--;</div><div class="line">    &#125; else &#123;</div><div class="line">      dedupe[aTag] = true;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  return tags;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>without mentioning the mysterious <code>splice</code> method with a dynamic <code>i</code> variable you need to brain-parse, the highlighted 2 lines are directly mutating the argument.</p>
<p>Imagine the <code>tags</code> argument passed in could be used in somewhere else, then this function has a side effect that is really hard to predict and could lead to a bug that is extremely hard to trace.</p>
<p>This is called <code>side effect</code> in functional programming world. and the <code>clean</code> function above is defined as <code>impure</code></p>
<h3 id="pure-function"><a href="#pure-function" class="headerlink" title="pure function"></a>pure function</h3><p>So we could come up with a better solution:</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">// ['tag1', 'tag2', 'tag1  '] -&gt; ['tag1', 'tag2']</div><div class="line">function clean(tags) &#123;</div><div class="line">  let dedupe = &#123;&#125;;</div><div class="line"><span class="addition">+ let result = [];</span></div><div class="line">  for (let i = 0; i &lt; tags.length; i++)&#123;</div><div class="line"><span class="deletion">-   tags[i] = tags[i].trim(); // mutates the tags</span></div><div class="line"><span class="addition">+   const aTag = tags[i].trim();</span></div><div class="line"></div><div class="line">    if(dedupe[aTag]) &#123;</div><div class="line"><span class="deletion">-     tags.splice(i, 1); // mutates the tags</span></div><div class="line"><span class="deletion">-     i--;</span></div><div class="line"><span class="addition">+     result.push(aTag);</span></div><div class="line">    &#125; else &#123;</div><div class="line">      dedupe[aTag] = true;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  return tags;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>with this implementation, at least we have get rid of the side effects and eliminated a potential caused by direct data mutation, but we could still do better:</p>
<h3 id="Concatenated-loops"><a href="#Concatenated-loops" class="headerlink" title="Concatenated loops"></a>Concatenated loops</h3><img src="/2016/12/19/javascript-102/loop-patterns.png" alt="Loop patterns" title="Loop patterns">
<p>As illustrated in the image above, generally a good practice is try to wring <code>Concatenated loop</code>.</p>
<p>To achieve this goal, we could follow a simple rule:</p>
<blockquote>
<p>Inside loop, try to do only 1 thing</p>
</blockquote>
<p>try to apply that to the <code>clean</code> function, we could get</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ['tag1', 'tag2', 'tag1'] -&gt; ['tag1', 'tag2']</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">clean</span>(<span class="params">tags</span>) </span>&#123;</div><div class="line">  <span class="keyword">let</span> dedupe = &#123;&#125;;</div><div class="line">  <span class="keyword">let</span> result = [];</div><div class="line"></div><div class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; tags.length; i++) &#123;</div><div class="line">    dedupe[tags[i].trim()] = <span class="literal">true</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; tags.length; i++) &#123;</div><div class="line">    <span class="keyword">if</span> (dedupe[tags[i].trim()]) &#123;</div><div class="line">      result.push(tags[i])</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Here inside those 2 loops, we could easily figure out what they are doing respectively.</p>
<h3 id="Lazy-evaluation"><a href="#Lazy-evaluation" class="headerlink" title="Lazy evaluation"></a>Lazy evaluation</h3><p>However, some people may ask: this is a <code>O(2n)</code> compared to the previous <code>O(n)</code> function.</p>
<p>Here will introduce the killer feature of <code>lodash</code> - chainable api</p>
<p>it is basically implemented using <code>_.chain(collection)</code> method, or <code>_(collection)</code> as a shorthand, and could be optimized easily</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> result = _(source).map(func1).map(func2).map(func3).value();</div></pre></td></tr></table></figure>
<p>is transformed to something like following in normal mode.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> result = [], temp1 = [], temp2 = [], temp3 = [];</div><div class="line"></div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; source.length; i++) &#123;</div><div class="line"> temp1[i] = func1(source[i]);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; source.length; i++) &#123;</div><div class="line"> temp2[i] = func2(temp1[i]);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; source.length; i++) &#123;</div><div class="line"> temp3[i] = func3(temp2[i]);</div><div class="line">&#125;</div><div class="line"></div><div class="line">result = temp3;</div></pre></td></tr></table></figure>
<p>But in the lazy mode (could be accomplished with <code>lazy.js</code>):</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> result = [];</div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; source.length; i++) &#123;</div><div class="line">  result[i] = func3(func2(func1(source[i])));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>as you could see, <code>O(kn)</code> algorithm has been optimized to <code>O(n)</code>. With pure <code>for</code> loop, this optimization is not easy to be achived, but with <code>lodash</code> and a sequence of function transformation, this could be easily achieved.</p>
<h3 id="Lodash-Chainable-API-rewrite-clean-function"><a href="#Lodash-Chainable-API-rewrite-clean-function" class="headerlink" title="Lodash Chainable API: rewrite clean function"></a>Lodash Chainable API: rewrite <code>clean</code> function</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ['tag1', 'tag2  ', 'tag1 '] -&gt; ['tag1', 'tag2']</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">clean</span>(<span class="params">tags</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> _(tags)</div><div class="line">    .map(_.trim)</div><div class="line">    .uniq()</div><div class="line">    .value();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>this is so much cleaner than the first version of above!</p>
<p>read the documentation on <a href="https://lodash.com/docs/4.17.2#chain" target="_blank" rel="external">lodash chain</a> for more black magic</p>
<h2 id="mergeAndOverwrite-function"><a href="#mergeAndOverwrite-function" class="headerlink" title="mergeAndOverwrite function"></a><code>mergeAndOverwrite</code> function</h2><p>consider the function below:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">mergeAndOverwrite</span>(<span class="params">target, source</span>) </span>&#123;</div><div class="line">  target = _.merge(_.cloneDeep(target), source.merge);</div><div class="line"></div><div class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> config_key <span class="keyword">in</span> source.overwrite) &#123;</div><div class="line">    <span class="keyword">if</span> (source.overwrite.hasOwnProperty(config_key)) &#123;</div><div class="line">      target[config_key] = source.overwrite[config_key];</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> target;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>there are 2 gotchas:</p>
<ol>
<li>1st parameter in <code>_.merge</code> could be an empty object, and <code>_.merge</code> is a recursive deep operation already, so <code>_.cloneDeep</code> is somewhat a cumbersome call.</li>
<li>the for … in loop could be entirely replaced by <code>Object.assign</code></li>
</ol>
<h3 id="merge-vs-Object-assign"><a href="#merge-vs-Object-assign" class="headerlink" title="_.merge vs Object.assign"></a>_.merge vs Object.assign</h3><p>Those 2 functions are similar but do things in totally different ways:</p>
<ol>
<li>.merge is a recursive call, so it traverses <strong>every</strong> property all object and merge them</li>
<li>Object.assign only overwrite the 1st layer of right hand-side to left hands-side</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// =&gt; &#123; "a": &#123; "a": "a","b":"bb" &#125;&#125;</span></div><div class="line">_.merge(&#123;&#125;, &#123;<span class="attr">a</span>:&#123;<span class="attr">a</span>:<span class="string">'a'</span>&#125;&#125;, &#123;<span class="attr">a</span>:&#123;<span class="attr">b</span>:<span class="string">'bb'</span>&#125;&#125;)</div><div class="line"><span class="comment">// =&gt; &#123; "a": &#123; "b": "bb" &#125;&#125;</span></div><div class="line"><span class="built_in">Object</span>.assign(&#123;&#125;, &#123;<span class="attr">a</span>:&#123;<span class="attr">a</span>:<span class="string">'a'</span>&#125;&#125;, &#123;<span class="attr">a</span>:&#123;<span class="attr">b</span>:<span class="string">'bb'</span>&#125;&#125;)</div><div class="line"></div><div class="line"><span class="comment">// =&gt; &#123; "a": [ "bb" ] &#125;</span></div><div class="line">_.merge(&#123;&#125;, &#123;<span class="attr">a</span>:[<span class="string">'a'</span>]&#125;, &#123;<span class="attr">a</span>:[<span class="string">'bb'</span>]&#125;)</div><div class="line"><span class="comment">// =&gt; &#123; "a": [ "bb" ] &#125;</span></div><div class="line"><span class="built_in">Object</span>.assign(&#123;&#125;, &#123;<span class="attr">a</span>:[<span class="string">'a'</span>]&#125;, &#123;<span class="attr">a</span>:[<span class="string">'bb'</span>]&#125;)</div></pre></td></tr></table></figure>
<h3 id="rewrite-the-mergeAndOverwrite-function"><a href="#rewrite-the-mergeAndOverwrite-function" class="headerlink" title="rewrite the mergeAndOverwrite function"></a>rewrite the <code>mergeAndOverwrite</code> function</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">mergeAndOverwrite</span>(<span class="params">target, source</span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> merged = _.merge(</div><div class="line">    &#123;&#125;,</div><div class="line">    target,</div><div class="line">    source.merge</div><div class="line">  );</div><div class="line">  <span class="keyword">return</span> <span class="built_in">Object</span>.assign(</div><div class="line">    merged,</div><div class="line">    source.overwrite</div><div class="line">  );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<div class="tip"><br>Read through Lodash doc before using _.cloneDeep<br></div>

<h2 id="Final-challenge-indentation-hell"><a href="#Final-challenge-indentation-hell" class="headerlink" title="Final challenge: indentation hell"></a>Final challenge: indentation hell</h2><p>To wrap up, consider the following function</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">filterAck</span>(<span class="params">acl_hash</span>) </span>&#123;</div><div class="line">  <span class="comment">// 0</span></div><div class="line">  <span class="keyword">let</span> filtered_api_acl = &#123;&#125;;</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> api_version <span class="keyword">in</span> acl_hash) &#123;</div><div class="line">    <span class="comment">// 1</span></div><div class="line">    <span class="keyword">if</span> (acl_hash.hasOwnProperty(api_version)) &#123;</div><div class="line">      <span class="comment">// 2</span></div><div class="line">      <span class="keyword">if</span> (config.api_key.default_user_api_acl[api_version]) &#123;</div><div class="line">        <span class="comment">// 3</span></div><div class="line">        filtered_api_acl[api_version] = [];</div><div class="line">        <span class="keyword">if</span> (_.isArray(acl_hash[api_version])) &#123;</div><div class="line">          <span class="comment">// 4</span></div><div class="line">          <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; acl_hash[api_version].length; i++) &#123;</div><div class="line">            <span class="comment">// 5</span></div><div class="line">            <span class="keyword">if</span> (config.api_key.default_user_api_acl[api_version].indexOf(acl_hash[api_version][i]) !== <span class="number">-1</span>) &#123;</div><div class="line">              <span class="comment">// 6</span></div><div class="line">              filtered_api_acl[api_version].push(acl_hash[api_version][i]);</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> filtered_api_acl;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<div class="tip"><br>We human beings are not good at reading deeply nested indentation hells: Research shows we only have 7 buffers for short term memory… So code like below will literally burn our brain out.<br></div>

<img src="/2016/12/19/javascript-102/indentation-hell.jpg" alt="indentation hell" title="indentation hell">
<p>Whenever writing code, try your best to keep the indentation level &lt;= 3 is generally a good practice, <strong>this could vastly improve maintainability of code.</strong></p>
<h3 id="1-use-Object-keys-to-iterate-an-object"><a href="#1-use-Object-keys-to-iterate-an-object" class="headerlink" title="1. use Object.keys to iterate an object"></a>1. use <code>Object.keys</code> to iterate an object</h3><p>indentation level <code>-1</code>, current <code>5</code></p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">function filterAck(acl_hash) &#123;</div><div class="line">  let filtered_api_acl = &#123;&#125;;</div><div class="line"><span class="deletion">- for (let api_version in acl_hash) &#123;</span></div><div class="line"><span class="deletion">-   if (acl_hash.hasOwnProperty(api_version)) &#123;</span></div><div class="line"><span class="addition">+ Object.keys(acl_hash).forEach(api_version =&gt; &#123;</span></div><div class="line"><span class="deletion">-     if (config.api_key.default_user_api_acl[api_version]) &#123;</span></div><div class="line"><span class="addition">+   if (config.api_key.default_user_api_acl[api_version]) &#123;</span></div><div class="line"><span class="deletion">-       filtered_api_acl[api_version] = [];</span></div><div class="line"><span class="addition">+     filtered_api_acl[api_version] = [];</span></div><div class="line"><span class="deletion">-       if (_.isArray(acl_hash[api_version])) &#123;</span></div><div class="line"><span class="addition">+     if (_.isArray(acl_hash[api_version])) &#123;</span></div><div class="line"><span class="deletion">-         for (let i = 0; i &lt; acl_hash[api_version].length; i++) &#123;</span></div><div class="line"><span class="addition">+       for (let i = 0; i &lt; acl_hash[api_version].length; i++) &#123;</span></div><div class="line"><span class="deletion">-           if (config.api_key.default_user_api_acl[api_version].indexOf(acl_hash[api_version][i]) !== -1) &#123;</span></div><div class="line"><span class="addition">+         if (config.api_key.default_user_api_acl[api_version].indexOf(acl_hash[api_version][i]) !== -1) &#123;</span></div><div class="line"><span class="deletion">-             filtered_api_acl[api_version].push(acl_hash[api_version][i]);</span></div><div class="line">            // 5</div><div class="line"><span class="addition">+           filtered_api_acl[api_version].push(acl_hash[api_version][i]);</span></div><div class="line"><span class="deletion">-           &#125;</span></div><div class="line"><span class="addition">+         &#125;</span></div><div class="line"><span class="deletion">-         &#125;</span></div><div class="line"><span class="addition">+       &#125;</span></div><div class="line"><span class="deletion">-       &#125;</span></div><div class="line"><span class="addition">+     &#125;</span></div><div class="line"><span class="deletion">-     &#125;</span></div><div class="line"><span class="addition">+   &#125;</span></div><div class="line"><span class="deletion">- &#125;</span></div><div class="line"><span class="addition">+ &#125;);</span></div><div class="line">  return filtered_api_acl;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-use-intersction-to-simplify-replace-the-inner-loop"><a href="#2-use-intersction-to-simplify-replace-the-inner-loop" class="headerlink" title="2. use _.intersction to simplify replace the inner loop"></a>2. use <code>_.intersction</code> to simplify replace the inner loop</h3><p>indentation level <code>-2</code>, current: <code>3</code></p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">function filterAcl(acl_hash) &#123;</div><div class="line">  let filtered_api_acl = &#123;&#125;;</div><div class="line">  Object.keys(acl_hash).forEach(api_version =&gt; &#123;</div><div class="line">    if (config.api_key.default_user_api_acl[api_version]) &#123;</div><div class="line"><span class="addition">+     filtered_api_acl[api_version] = [];</span></div><div class="line">      if (_.isArray(acl_hash[api_version])) &#123;</div><div class="line"><span class="deletion">-       for (let i = 0; i &lt; acl_hash[api_version].length; i++) &#123;</span></div><div class="line"><span class="deletion">-         if (config.api_key.default_user_api_acl[api_version].indexOf(acl_hash[api_version][i]) !== -1) &#123;</span></div><div class="line"><span class="deletion">-           filtered_api_acl[api_version].push(acl_hash[api_version][i]);</span></div><div class="line"><span class="deletion">-         &#125;</span></div><div class="line"><span class="deletion">-       &#125;</span></div><div class="line">        // 3</div><div class="line"><span class="addition">+       filtered_api_acl[api_version] = _.intersction(</span></div><div class="line"><span class="addition">+         config.api_key.default_user_api_acl[api_version],</span></div><div class="line"><span class="addition">+         acl_hash</span></div><div class="line"><span class="addition">+       )</span></div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;)</div><div class="line">  return filtered_api_acl;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-return-in-advance-to-reduce-indentation-level"><a href="#3-return-in-advance-to-reduce-indentation-level" class="headerlink" title="3. return in advance to reduce indentation level"></a>3. return in advance to reduce indentation level</h3><p>indentation level <code>-1</code>, current <code>2</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">filterAcl</span>(<span class="params">acl_hash</span>) </span>&#123;</div><div class="line">  <span class="keyword">let</span> filtered_api_acl = &#123;&#125;;</div><div class="line">  <span class="built_in">Object</span>.keys(acl_hash).forEach(<span class="function"><span class="params">api_version</span> =&gt;</span> &#123;</div><div class="line">    <span class="keyword">if</span> (!config.api_key.default_user_api_acl[api_version]) &#123;</div><div class="line">      <span class="comment">// 2</span></div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!_.isArray(acl_hash[api_version])) &#123;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    filtered_api_acl[api_version] = [];</div><div class="line"></div><div class="line">    filtered_api_acl[api_version] = _.intersection(</div><div class="line">      config.api_key.default_user_api_acl[api_version],</div><div class="line">      acl_hash[api_version]</div><div class="line">    );</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  <span class="keyword">return</span> filtered_api_acl;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="4-final-step-use-lodash-to-wrap-everything"><a href="#4-final-step-use-lodash-to-wrap-everything" class="headerlink" title="4. final step: use lodash to wrap everything"></a>4. final step: use lodash to wrap everything</h3><p>indentation level <code>-2</code>, current <code>0</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">filterAcl</span>(<span class="params">acl_hash</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> _</div><div class="line">    .chain(<span class="built_in">Object</span>.keys(acl_hash))</div><div class="line">    .filter(<span class="function"><span class="params">api_version</span> =&gt;</span> config.api_key.default_user_api_acl[api_version])</div><div class="line">    .filter(<span class="function"><span class="params">api_version</span> =&gt;</span> <span class="built_in">Array</span>.isArray(acl_hash[api_version]))</div><div class="line">    .map(<span class="function"><span class="params">api_version</span> =&gt;</span> ([</div><div class="line">      api_version,</div><div class="line">      _.intersection(</div><div class="line">        config.api_key.default_user_api_acl,</div><div class="line">        acl_hash[api_version]</div><div class="line">      )</div><div class="line">    ]))</div><div class="line">    .fromPairs()</div><div class="line">    .value();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Final-Words"><a href="#Final-Words" class="headerlink" title="Final Words"></a>Final Words</h2><div class="tip"><br>Use Lodash!<br></div>

<h4 id="references"><a href="#references" class="headerlink" title="references:"></a>references:</h4><ul>
<li><a href="https://lodash.com/docs/4.17.2" target="_blank" rel="external">lodash-doc</a></li>
<li><a href="http://philosopherdeveloper.com/posts/introducing-lazy-js.html" target="_blank" rel="external">lazy-js-intro</a></li>
<li><a href="http://stackoverflow.com/questions/500504/why-is-using-for-in-with-array-iteration-a-bad-idea" target="_blank" rel="external">for-in-stackoverflow</a></li>
<li><a href="https://laracasts.com/series/simple-rules-for-simpler-code" target="_blank" rel="external">simple-rules-for-simple-code</a></li>
</ul>
</div></article></div></main><footer><div class="paginator"></div><div class="copyright"><p>© 2016 <a href="http://techblog.aftership.com">Aftership Engineer</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-28584597-12",'auto');ga('send','pageview');</script></body></html>